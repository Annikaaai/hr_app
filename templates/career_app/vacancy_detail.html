{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<!-- Hero Section for Vacancy Detail -->
<section class="vacancy-hero-section" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e8f5e9 100%); padding: 3rem 0; position: relative; overflow: hidden;">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb" style="background: rgba(255,255,255,0.9); padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08);">
                <li class="breadcrumb-item"><a href="{% url 'home' %}" style="color: #4caf50; text-decoration: none;">Главная</a></li>
                <li class="breadcrumb-item"><a href="{% url 'vacancy_list' %}" style="color: #4caf50; text-decoration: none;">Вакансии</a></li>
                <li class="breadcrumb-item active">{{ vacancy.title|truncatewords:5 }}</li>
            </ol>
        </nav>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <div class="vacancy-card" style="background: white; border-radius: 24px; padding: 2.5rem; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #e9ecef; position: relative; overflow: hidden;">
                    <!-- Decorative Elements -->
                    <div class="vacancy-bg-element element-1" style="position: absolute; top: -30px; right: -30px; width: 120px; height: 120px; background: rgba(76, 175, 80, 0.1); border-radius: 50%; animation: float 6s ease-in-out infinite;"></div>

                    <!-- Status Badge -->
                    {% if vacancy.status != 'published' %}
                    <div class="status-badge mb-4" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #fff3cd; color: #856404; padding: 10px 20px; border-radius: 25px; font-weight: 600; border: 1px solid #ffeaa7;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Статус: {{ vacancy.get_status_display }}
                        {% if user.userprofile.role == 'hr' and vacancy.company == user.userprofile.company %}
                        <small style="margin-left: 0.5rem; opacity: 0.8;">(видна только вам и администраторам)</small>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Vacancy Header -->
                    <div class="vacancy-header mb-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h1 class="vacancy-title" style="font-size: 2.5rem; font-weight: 700; color: #1a1a1a; margin-bottom: 0.5rem; line-height: 1.2;">
                                    {{ vacancy.title }}
                                </h1>
                                <div class="company-info" style="display: flex; align-items: center; gap: 1rem;">
                                    <h3 class="company-name" style="color: #4caf50; font-weight: 600; margin: 0;">
                                        {{ vacancy.company.name }}
                                    </h3>
                                    <div class="company-rating" style="color: #ffc107;">
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star"></i>
                                        <i class="fas fa-star-half-alt"></i>
                                    </div>
                                </div>
                            </div>
                            {% if vacancy.salary %}
                            <div class="salary-badge" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color: white; padding: 1rem 1.5rem; border-radius: 16px; text-align: center; box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);">
                                <div class="salary-label" style="font-size: 0.9rem; opacity: 0.9;">Зарплата</div>
                                <div class="salary-amount" style="font-size: 1.5rem; font-weight: 700;">{{ vacancy.salary }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Vacancy Meta -->
                    <div class="vacancy-meta mb-4" style="display: flex; gap: 2rem; flex-wrap: wrap;">
                        <div class="meta-item" style="display: flex; align-items: center; gap: 0.5rem; color: #666;">
                            <i class="fas fa-map-marker-alt" style="color: #4caf50;"></i>
                            <span>Москва, ОЭЗ «Технополис»</span>
                        </div>
                        <div class="meta-item" style="display: flex; align-items: center; gap: 0.5rem; color: #666;">
                            <i class="fas fa-clock" style="color: #4caf50;"></i>
                            <span>Опыт: 1-3 года</span>
                        </div>
                        <div class="meta-item" style="display: flex; align-items: center; gap: 0.5rem; color: #666;">
                            <i class="fas fa-calendar" style="color: #4caf50;"></i>
                            <span>Создана: {{ vacancy.created_at|date:"d.m.Y" }}</span>
                        </div>
                    </div>

                    <!-- Vacancy Content -->
                    <div class="vacancy-content">
                        <div class="content-section mb-4">
                            <h4 style="color: #1a1a1a; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file-alt" style="color: #4caf50;"></i>
                                Описание вакансии
                            </h4>
                            <div class="content-text" style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; line-height: 1.6; color: #333;">
                                {{ vacancy.description|linebreaks }}
                            </div>
                        </div>

                        <div class="content-section mb-4">
                            <h4 style="color: #1a1a1a; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-list-check" style="color: #4caf50;"></i>
                                Требования
                            </h4>
                            <div class="content-text" style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px; line-height: 1.6; color: #333;">
                                {{ vacancy.requirements|linebreaks }}
                            </div>
                        </div>


                    </div>

                    <!-- Date Information -->
                    <div class="vacancy-dates mt-4 pt-4" style="border-top: 1px solid #e9ecef;">
                        <p class="text-muted" style="margin: 0;">
                            <small>Создана: {{ vacancy.created_at|date:"d.m.Y" }}</small>
                            {% if vacancy.published_at %}
                            <br><small>Опубликована: {{ vacancy.published_at|date:"d.m.Y" }}</small>
                            {% endif %}
                        </p>
                    </div>

                    <!-- Navigation -->
                    <div class="vacancy-navigation mt-4 pt-4" style="border-top: 1px solid #e9ecef;">
                        {% if user.is_authenticated and user.userprofile.role == 'hr' and vacancy.company == user.userprofile.company %}
                        <a href="{% url 'hr_dashboard' %}" class="btn-navigation" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #6c757d; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease;">
                            <i class="fas fa-arrow-left"></i>
                            Назад к моим вакансиям
                        </a>
                        {% else %}
                        <a href="{% url 'vacancy_list' %}" class="btn-navigation" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #6c757d; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease;">
                            <i class="fas fa-arrow-left"></i>
                            Все вакансии
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Application Card -->
                <div class="application-card" style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #e9ecef; margin-bottom: 1.5rem; position: relative; overflow: hidden;">
                    <div class="application-bg-element" style="position: absolute; bottom: -20px; left: -20px; width: 80px; height: 80px; background: rgba(76, 175, 80, 0.05); border-radius: 50%;"></div>

                    <h5 class="card-title mb-3" style="color: #1a1a1a; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-paper-plane" style="color: #4caf50;"></i>
                        Откликнуться на вакансию
                    </h5>

                    {% if vacancy.status != 'published' %}
                    <div class="alert-warning" style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 12px; border: 1px solid #ffeaa7; margin-bottom: 1rem;">
                        <p style="margin: 0 0 0.5rem 0;">На эту вакансию пока нельзя откликнуться.</p>
                        <p style="margin: 0; font-weight: 600;">Статус: {{ vacancy.get_status_display }}</p>
                    </div>
                    {% else %}
                        {% if user.is_authenticated %}
                            {% if user.userprofile.role == 'applicant' %}
                                {% if not user.applicant %}
                                <div class="alert-warning" style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 12px; border: 1px solid #ffeaa7; margin-bottom: 1rem;">
                                    <p style="margin: 0 0 1rem 0;">Для отклика на вакансию необходимо заполнить профиль соискателя.</p>
                                    <a href="{% url 'create_applicant_profile' %}" class="btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #4caf50; color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease;">
                                        <i class="fas fa-user-edit"></i>
                                        Заполнить профиль
                                    </a>
                                </div>
                                {% elif has_applied %}
                                <div class="alert-success" style="background: #d4edda; color: #155724; padding: 1.5rem; border-radius: 12px; border: 1px solid #c3e6cb; text-align: center;">
                                    <i class="fas fa-check-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #28a745;"></i>
                                    <p style="margin: 0 0 1rem 0; font-weight: 600;">Вы уже откликнулись на эту вакансию</p>
                                    {% if show_chat_button and chat_thread %}
                                    <div class="mt-3">
                                        <a href="{% url 'chat_detail' chat_thread.id %}" class="btn-chat" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #4caf50; color: white; padding: 1rem 1.5rem; border-radius: 12px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; width: 100%; justify-content: center;">
                                            <i class="fas fa-comments"></i>
                                            Перейти в чат с HR
                                        </a>
                                        <p class="text-muted small mt-2" style="color: #6c757d; margin: 0.5rem 0 0 0;">Чат создан и готов к общению</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% else %}
                                <form method="post">
                                    {% csrf_token %}
                                    <div class="form-group mb-3">
                                        <label for="cover_letter" class="form-label" style="font-weight: 600; color: #1a1a1a; margin-bottom: 0.5rem;">Сопроводительное письмо</label>
                                        <textarea name="cover_letter" id="cover_letter" rows="4" class="form-control"
                                                  placeholder="Расскажите почему вы подходите для этой вакансии..."
                                                  style="border-radius: 12px; border: 1px solid #e9ecef; padding: 1rem; transition: all 0.3s ease; resize: vertical;"></textarea>
                                    </div>
                                    <button type="submit" class="btn-apply" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); border: none; color: white; padding: 1rem 2rem; border-radius: 12px; font-weight: 600; transition: all 0.3s ease; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                        <i class="fas fa-paper-plane"></i>
                                        Отправить отклик
                                    </button>
                                    <p class="text-muted small mt-2" style="color: #6c757d; text-align: center; margin: 0.5rem 0 0 0;">После отправки отклика сразу откроется чат с HR</p>
                                </form>
                                {% endif %}
                            {% else %}
                            <div class="alert-info" style="background: #d1ecf1; color: #0c5460; padding: 1.5rem; border-radius: 12px; border: 1px solid #bee5eb; text-align: center;">
                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; color: #17a2b8;"></i>
                                <p style="margin: 0 0 0.5rem 0;">Откликаться на вакансии могут только соискатели.</p>
                                {% if user.userprofile.role != 'applicant' %}
                                <p style="margin: 0; font-weight: 500;">Ваша текущая роль: {{ user.userprofile.get_role_display }}</p>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% else %}
                            <div class="alert-warning" style="background: #fff3cd; color: #856404; padding: 1.5rem; border-radius: 12px; border: 1px solid #ffeaa7; text-align: center;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; color: #ffc107;"></i>
                                <p style="margin: 0 0 1rem 0;">Для отклика на вакансию необходимо войти в систему.</p>
                                <div class="auth-buttons" style="display: flex; gap: 0.5rem; flex-direction: column;">
                                    <a href="{% url 'role_selection' %}" class="btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #4caf50; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; justify-content: center;">
                                        <i class="fas fa-sign-in-alt"></i>
                                        Войти в систему
                                    </a>
                                    <a href="{% url 'register' %}#top" class="btn-outline" style="display: inline-flex; align-items: center; gap: 0.5rem; background: transparent; border: 1px solid #4caf50; color: #4caf50; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; justify-content: center;">
                                        <i class="fas fa-user-plus"></i>
                                        Зарегистрироваться
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>

                <!-- HR Management Card -->
                {% if user.is_authenticated and user.userprofile.role == 'hr' and vacancy.company == user.userprofile.company %}
                <div class="hr-card" style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 15px 35px rgba(0,0,0,0.1); border: 1px solid #e9ecef; position: relative; overflow: hidden;">
                    <div class="hr-bg-element" style="position: absolute; top: -15px; right: -15px; width: 60px; height: 60px; background: rgba(13, 110, 253, 0.1); border-radius: 50%;"></div>

                    <h6 style="color: #1a1a1a; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-cog" style="color: #0d6efd;"></i>
                        Управление вакансией
                    </h6>

                    <div class="hr-stats" style="margin-bottom: 1.5rem;">
                        <div class="stat-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #f1f3f4;">
                            <span style="color: #666;">Статус:</span>
                            <strong style="color: #1a1a1a;">{{ vacancy.get_status_display }}</strong>
                        </div>
                        <div class="stat-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                            <span style="color: #666;">Откликов:</span>
                            <strong style="color: #1a1a1a;">{{ vacancy.application_set.count }}</strong>
                        </div>
                    </div>

                    <div class="hr-actions">
                        <a href="{% url 'chat_list' %}" class="btn-chat-list" style="display: inline-flex; align-items: center; gap: 0.5rem; background: #0d6efd; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s ease; width: 100%; justify-content: center;">
                            <i class="fas fa-comments"></i>
                            Перейти к чатам с соискателями
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<style>
    /* Animation for decorative elements */
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }

    /* Hover effects */
    .btn-navigation:hover,
    .btn-primary:hover,
    .btn-apply:hover,
    .btn-chat:hover,
    .btn-chat-list:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
    }

    .btn-outline:hover {
        background: #4caf50 !important;
        color: white !important;
        transform: translateY(-2px);
    }

    /* Form input focus effects */
    .form-control:focus {
        border-color: #4caf50 !important;
        box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25) !important;
        transform: translateY(-1px);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .vacancy-card,
        .application-card,
        .hr-card {
            padding: 1.5rem !important;
        }

        .vacancy-title {
            font-size: 2rem !important;
        }

        .vacancy-meta {
            flex-direction: column;
            gap: 1rem !important;
        }

        .salary-badge {
            margin-top: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add animation to cards
        const cards = document.querySelectorAll('.vacancy-card, .application-card, .hr-card');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.animation = `fadeInUp 0.6s ease-out ${0.3 + index * 0.1}s forwards`;
        });

        // Add focus effect to textarea
        const textarea = document.getElementById('cover_letter');
        if (textarea) {
            textarea.addEventListener('focus', function() {
                this.style.borderColor = '#4caf50';
                this.style.boxShadow = '0 0 0 0.2rem rgba(76, 175, 80, 0.25)';
            });

            textarea.addEventListener('blur', function() {
                this.style.borderColor = '#e9ecef';
                this.style.boxShadow = 'none';
            });
        }
    });

    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}